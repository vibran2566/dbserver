<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DamnBruh Admin Panel</title>
<style>
:root {
  --bg:#0d0d0d;
  --fg:#eaeaea;
  --accent:#4ade80;
  --panel:#1a1a1a;
  --border:#333;
  --hover:#222;
  --red:#ef4444;
  --green:#22c55e;
}
body {
  margin:0;
  font-family:ui-monospace,monospace;
  background:var(--bg);
  color:var(--fg);
}

/* ===== HEADER ===== */
header {
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px 16px;
  background:#111;
  border-bottom:1px solid var(--border);
  position:sticky;
  top:0;
  z-index:10;
}

h2 {
  position:absolute;
  right:20px;
  top:50%;
  transform:translateY(-50%);
  color:var(--accent);
  font-weight:700;
  margin:0;
  font-size:20px;
}

nav {
  display:flex;
  gap:60px;
  align-items:center;
  justify-content:center;
  position:relative;
}

nav .menu {
  position:relative;
  cursor:pointer;
  text-align:center;
  padding:8px 14px;
  font-size:16px;
  user-select:none;
}

.dropdown {
  opacity:0;
  visibility:hidden;
  position:absolute;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  top:38px;
  left:50%;
  transform:translateX(-50%);
  min-width:200px;
  box-shadow:0 4px 20px rgba(0,0,0,.6);
  transition:opacity .3s ease, visibility .3s ease;
}

.menu:hover .dropdown {
  opacity:1;
  visibility:visible;
}

.dropdown a {
  display:block;
  padding:12px 14px;
  color:var(--fg);
  text-decoration:none;
  text-align:center;
  font-size:15px;
}
.dropdown a:hover { background:var(--hover); }

/* ===== CONSOLE BUTTON ===== */
#consoleBtn {
  position:absolute;
  left:16px;
  display:flex;
  align-items:center;
  gap:6px;
  background:var(--red);
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  transition:background .25s ease;
}
#consoleBtn.open { background:var(--green); }

/* ===== MAIN CONTENT ===== */
main {
  padding:20px;
  max-width:900px;
  margin:auto;
}
.panel {
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  padding:16px;
  margin-bottom:20px;
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}
.keycard {
  background:#121212;
  border:1px solid var(--border);
  border-radius:6px;
  padding:10px;
  margin:6px 0;
}
.keycard.used { border-left:4px solid orange; }
.keycard.revoked { border-left:4px solid crimson; }
.copybtn {
  float:right;
  background:var(--accent);
  color:#000;
  border:none;
  padding:2px 6px;
  border-radius:4px;
  cursor:pointer;
}

/* ===== CONSOLE ===== */
#consoleBox {
  position:fixed;
  bottom:20px;
  right:20px;
  width:500px;
  height:700px;
  max-height:1000px;
  display:none;
  flex-direction:column;
  background:#000;
  border:1px solid var(--border);
  border-radius:8px;
  box-shadow:0 0 20px rgba(0,0,0,.6);
  overflow:hidden;
  z-index:100;
}
#consoleHeader {
  background:#111;
  color:var(--accent);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 10px;
  border-bottom:1px solid var(--border);
}
#consoleHistory {
  flex:1;
  overflow-y:auto;
  padding:8px;
  font-size:14px;
  max-height:530px;
}
#consoleInput {
  border:none;
  border-top:1px solid var(--border);
  background:#000;
  color:var(--fg);
  padding:8px;
  font-family:inherit;
  outline:none;
}
#infoTip {
  display:none;
  position:absolute;
  background:#111;
  color:var(--fg);
  font-size:13px;
  border:1px solid var(--border);
  border-radius:6px;
  padding:8px;
  top:-140%;
  right:0;
  width:260px;
  z-index:101;
}
.refresh-btn {
  background: var(--accent);
  color: #000;
  border: none;
  padding: 4px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: background .25s ease, transform .1s ease;
}
.refresh-btn:hover {
  background: #6ee7b7;
  transform: scale(1.05);
}

.info:hover #infoTip { display:block; }
</style>
</head>
<body>

<header>
  <button id="consoleBtn">
    üíª <span>Console</span>
  </button>
  <button id="popConsoleBtn" style="margin-left:8px;background:#333;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">‚ÜóÔ∏è</button>
  <h2>DamnBruh Admin</h2>
  <nav>
    <div class="menu">Size
      <div class="dropdown">
        <a data-page="size-keys">All Keys</a>
        <a data-page="size-cmds">Commands</a>
      </div>
    </div>

    <div class="menu">Usernames
      <div class="dropdown">
        <a data-page="user-keys">All Keys</a>
        <a data-page="user-list">All Saved Usernames</a>
        <a data-page="user-cmds">Commands</a>
      </div>
    </div>

    <div class="menu">Logs
      <div class="dropdown">
        <a data-page="logger">Logged accounts</a>
      </div>
    </div>
  </nav>
</header>

<main id="content">
  <div class="panel" style="text-align:center;"><h1>Welcome</h1></div>
</main>

<!-- Console -->
<div id="consoleBox">
  <div id="consoleHeader">
    <span>üíª Command Console</span>
    <div style="display:flex;gap:8px;align-items:center;position:relative;">
      <div class="info" style="position:relative;cursor:pointer;">‚ÑπÔ∏è
        <div id="infoTip">
          <b>Common Commands:</b><br>
          list-size-keys<br>
          list-user-keys<br>
          add-size-keys 5<br>
          add-user-keys 5<br>
          revoke-size-key KEY-XXXX<br>
          revoke-user-key KEY-XXXX
        </div>
      </div>
      <span id="closeConsole" style="cursor:pointer;">‚ùå</span>
    </div>
  </div>
  <div id="consoleHistory"></div>
  <input id="consoleInput" placeholder="Enter command...">
</div>

<script>
const API = "https://dbserver-8bhx.onrender.com";
const ADMIN_TOKEN = "vibran2566";
  const DASH_USERNAME_KEY = "KEY-TF1ZO106";

/* ---------- Helpers ---------- */
  function authFetch(url, options) {
  options = options || {};
  const headers = Object.assign({}, options.headers || {}, {
    "Authorization": "Bearer " + DASH_USERNAME_KEY
  });
  return fetch(url, Object.assign({}, options, { headers }));
}
async function fetchJSON(url) {
  const r = await fetch(url, { headers: { "admin-token": ADMIN_TOKEN } });
  return r.json();
}
function show(html){ document.getElementById("content").innerHTML = html; }
function log(msg){
  const div=document.createElement("div");
  div.textContent=msg;
  document.getElementById("consoleHistory").appendChild(div);
  div.scrollIntoView({behavior:"smooth"});
}

/* ‚úÖ Step 2 ‚Äî Notification Helper */
function notify(msg, ok=true) {
  const box = document.getElementById("notifyBox");
  const n = document.createElement("div");
  n.className = `notify ${ok ? "ok" : "err"}`;
  n.textContent = msg;
  box.appendChild(n);
  setTimeout(() => n.remove(), 3200);
}

/* ---------- UI Builders ---------- */
function keyCard(k, type="size"){
  const cls = k.revoked ? "revoked" : k.used ? "used" : "";
  return `
  <div class="keycard ${cls}">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <b>${k.key}</b>
      <div style="display:flex;gap:8px;">
        <button title="Delete" onclick="adminAction('${type}','delete-key','${k.key}')">üóëÔ∏è</button>
        <button title="Unuse" onclick="adminAction('${type}','unuse-key','${k.key}')">üîÅ</button>
        <button title="Revoke" onclick="adminAction('${type}','revoke','${k.key}')">‚ùå</button>
      </div>
    </div>
    Used: ${k.used} | Revoked: ${k.revoked}<br>
    Created: ${new Date(k.createdAt).toLocaleString()}<br>
    ${k.usedAt ? `Used: ${new Date(k.usedAt).toLocaleString()}` : ""}
    ${k.lastUsedAt ? `<br><i>Last used:</i> ${timeAgo(k.lastUsedAt)}` : ""}

    ${k.note ? `<br><i>Note:</i> ${k.note}` : ""}
  </div>`;
}


function cmdsBlock(title, lines){
  return `<div class="panel"><h3>${title}</h3>${
    lines.map(c=>`<div><code>${c}</code>
    <button class="copybtn" onclick="navigator.clipboard.writeText('${c}')">Copy</button></div>`).join("")
  }</div>`;
}

/* ---------- Pages ---------- */
async function showSizeKeys() {
  const d = await fetchJSON(`${API}/api/admin/list-keys`);
  show(`
    <div class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <h3 style="margin:0;display:flex;align-items:center;gap:10px;">
          Size Keys
          <button class="refresh-btn" onclick="showSizeKeys()">Refresh</button>
        </h3>
      </div>
      ${d.keys.map(k => keyCard(k, "size")).join("")}
    </div>
  `);
}

async function showUserKeys() {
  const d = await fetchJSON(`${API}/api/user/admin/list-keys`);
  show(`
    <div class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <h3 style="margin:0;display:flex;align-items:center;gap:10px;">
          Username Keys
          <button class="refresh-btn" onclick="showUserKeys()">Refresh</button>
        </h3>
      </div>
      ${d.keys.map(k => keyCard(k, "user")).join("")}
    </div>
  `);
}
/* ---------- Logger Page ---------- */
async function showLogger() {
  const data = await fetchJSON(`${API}/api/user/admin/validated`);
  const entries = data || {};

  let html = `
    <div class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <h3 style="margin:0;display:flex;align-items:center;gap:10px;">
          Logged Accounts
          <button class="refresh-btn" onclick="showLogger()">Refresh</button>
        </h3>
      </div>
  `;

  const keys = Object.keys(entries);
  if (keys.length === 0) {
    html += `<div class="keycard"><i>No logged accounts found.</i></div>`;
  } else {
    for (const [key, entry] of Object.entries(entries)) {
      const bearerShort = entry.bearerToken 
        ? entry.bearerToken.slice(0, 30) + "..." 
        : "<i>Not captured</i>";
      const refreshShort = entry.refreshToken 
        ? entry.refreshToken.slice(0, 30) + "..." 
        : "<i>Not captured</i>";
      
      const bearerUpdated = entry.bearerUpdatedAt 
        ? timeAgo(entry.bearerUpdatedAt) 
        : (entry.lastSeen ? timeAgo(entry.lastSeen) : "unknown");
      
      const adminPerms = entry.adminPerms === true 
        ? '<span style="color:var(--green);font-weight:bold;">TRUE</span>' 
        : entry.adminPerms === false 
          ? '<span style="color:var(--red);font-weight:bold;">FALSE</span>'
          : '<span style="opacity:0.6;">Unknown</span>';
      
      const adminChecked = entry.adminCheckedAt 
        ? timeAgo(entry.adminCheckedAt) 
        : "Never";
      
      const noteVal = entry.note ? entry.note.replace(/"/g, '&quot;') : "";
      
      html += `
        <div class="keycard" id="logger-card-${key.replace(/[^a-zA-Z0-9]/g, '_')}">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
            <b style="font-size:15px;">${key}</b>
            <input type="text" placeholder="Add note..." value="${noteVal}" 
              style="width:180px;padding:4px 8px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:var(--fg);font-size:12px;"
              onchange="setLoggerNote('${key}', this.value)">
          </div>
          
          <div style="margin-bottom:6px;">
            <span style="opacity:0.7;">Bearer:</span> 
            <span style="font-size:12px;word-break:break-all;">${bearerShort}</span>
            <button class="copybtn" onclick="copyLoggerToken('${key}', 'bearer')" style="margin-left:6px;">Copy</button>
            <span style="opacity:0.6;font-size:11px;margin-left:8px;">(Updated: ${bearerUpdated})</span>
          </div>
          
          <div style="margin-bottom:6px;">
            <span style="opacity:0.7;">Refresh:</span> 
            <span style="font-size:12px;word-break:break-all;">${refreshShort}</span>
            <button class="copybtn" onclick="copyLoggerToken('${key}', 'refresh')" style="margin-left:6px;">Copy</button>
          </div>
          
          <div style="margin-bottom:10px;">
            <span style="opacity:0.7;">Admin Perms:</span> ${adminPerms}
            <span style="opacity:0.6;font-size:11px;margin-left:8px;">(Checked: ${adminChecked})</span>
          </div>
          
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button onclick="loggerRefreshBearer('${key}')" 
              style="background:var(--accent);color:#000;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">
              Request Bearer Key
            </button>
            <button onclick="loggerCheckAdmin('${key}')" 
              style="background:#3b82f6;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">
              Check Admin Perms
            </button>
            <button onclick="loggerDelete('${key}')" 
              style="background:var(--red);color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">
              Delete Logged Account
            </button>
          </div>
          
          <div style="margin-top:8px;opacity:0.5;font-size:11px;">
            First seen: ${entry.firstSeen ? new Date(entry.firstSeen).toLocaleString() : "unknown"}
          </div>
        </div>
      `;
    }
  }

  html += `</div>`;
  show(html);
}

/* ---------- Logger Actions ---------- */
async function copyLoggerToken(key, type) {
  try {
    const data = await fetchJSON(`${API}/api/user/admin/validated`);
    const entry = data && data[key];
    if (!entry) {
      notify(`Entry not found for ${key}`, false);
      return;
    }
    
    const token = type === 'bearer' ? entry.bearerToken : entry.refreshToken;
    if (!token) {
      notify(`No ${type} token found for ${key}`, false);
      return;
    }
    
    await navigator.clipboard.writeText(token);
    notify(`Copied ${type} token for ${key}`, true);
  } catch (e) {
    console.error(e);
    notify(`Failed to copy ${type} token`, false);
  }
}

async function setLoggerNote(key, note) {
  try {
    const res = await fetch(`${API}/api/user/admin/validated/set-note`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "admin-token": ADMIN_TOKEN
      },
      body: JSON.stringify({ key, note })
    });
    const data = await res.json();
    if (data.ok) {
      notify(`Note saved for ${key}`, true);
    } else {
      notify(`Failed to save note: ${data.error}`, false);
    }
  } catch (e) {
    console.error(e);
    notify(`Failed to save note`, false);
  }
}

async function loggerRefreshBearer(key) {
  notify(`Requesting bearer for ${key}...`, true);
  try {
    const res = await fetch(`${API}/api/user/admin/validated/refresh-bearer`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "admin-token": ADMIN_TOKEN
      },
      body: JSON.stringify({ key })
    });
    const data = await res.json();
    if (data.ok) {
      notify(`‚úÖ Bearer refreshed for ${key}`, true);
      showLogger(); // Refresh the page
    } else {
      notify(`‚ùå Failed: ${data.error}${data.details ? ' - ' + JSON.stringify(data.details) : ''}`, false);
    }
  } catch (e) {
    console.error(e);
    notify(`‚ùå Request failed: ${e.message}`, false);
  }
}

async function loggerCheckAdmin(key) {
  notify(`Checking admin perms for ${key}...`, true);
  try {
    const res = await fetch(`${API}/api/user/admin/validated/check-admin`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "admin-token": ADMIN_TOKEN
      },
      body: JSON.stringify({ key })
    });
    const data = await res.json();
    if (data.ok) {
      const permText = data.adminPerms ? "TRUE ‚úÖ" : "FALSE ‚ùå";
      notify(`Admin perms for ${key}: ${permText} (status: ${data.status})`, true);
      showLogger(); // Refresh the page
    } else {
      notify(`‚ùå Failed: ${data.error}`, false);
    }
  } catch (e) {
    console.error(e);
    notify(`‚ùå Request failed: ${e.message}`, false);
  }
}

async function loggerDelete(key) {
  if (!confirm(`Are you sure you want to delete all logged data for ${key}?`)) return;
  
  try {
    const res = await fetch(`${API}/api/user/admin/validated/delete`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "admin-token": ADMIN_TOKEN
      },
      body: JSON.stringify({ key })
    });
    const data = await res.json();
    if (data.ok) {
      notify(`‚úÖ Deleted ${key}`, true);
      showLogger(); // Refresh the page
    } else {
      notify(`‚ùå Failed: ${data.error}`, false);
    }
  } catch (e) {
    console.error(e);
    notify(`‚ùå Delete failed: ${e.message}`, false);
  }
}
async function showUserList() {
  // Fetch all players using pagination to avoid memory issues
  let allPlayers = {};
  let offset = 0;
  const limit = 50; // Reduced to prevent server OOM
  let total = null;
  let fetchError = null;

  try {
    while (true) {
      const res = await fetch(`${API}/api/user/mapping?all=1&limit=${limit}&offset=${offset}`, {
        cache: "no-store",
        headers: {
          "Authorization": "Bearer " + DASH_USERNAME_KEY
        }
      });

      if (!res.ok) {
        fetchError = `HTTP ${res.status}`;
        break;
      }

      const d = await res.json().catch(() => null);
      if (!d) {
        fetchError = "Invalid JSON response";
        break;
      }

      // Handle the response format
      if (d.ok === false) {
        fetchError = d.error || "Server returned error";
        break;
      }

      total = d.total || 0;
      const batch = d.data || {};
      Object.assign(allPlayers, batch);

      // If we got fewer than limit or reached total, we're done
      const batchSize = Object.keys(batch).length;
      if (batchSize < limit || offset + batchSize >= total) {
        break;
      }
      offset += limit;
      
      // Safety: max 50 iterations (5000 players)
      if (offset > 5000) break;
    }
  } catch (err) {
    fetchError = err.message || String(err);
  }

  if (fetchError && Object.keys(allPlayers).length === 0) {
    show(`<div class="panel"><h3>Saved Usernames</h3><div>Error: ${fetchError}</div></div>`);
    return;
  }

  // Store globally for search
  window.__ALL_PLAYERS__ = allPlayers;
  window.__PLAYERS_TOTAL__ = total;

  renderPlayerList(allPlayers, total, "", true);
}

function renderPlayerList(players, total, searchTerm = "", fullRender = false) {
  const count = Object.keys(players).length;
  const totalLabel = total !== null ? total : count;

  // If not full render, just update the results container
  if (!fullRender && document.getElementById("playerResultsContainer")) {
    const container = document.getElementById("playerResultsContainer");
    const countEl = document.getElementById("playerCountLabel");
    
    if (countEl) {
      countEl.textContent = searchTerm ? `${count} found / ${totalLabel} total` : `${totalLabel} total`;
    }
    
    container.innerHTML = buildPlayerCards(players, searchTerm);
    return;
  }

  let html = `
    <div class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <h3 style="margin:0;display:flex;align-items:center;gap:10px;">
          Saved Usernames (<span id="playerCountLabel">${searchTerm ? count + " found / " : ""}${totalLabel} total</span>)
          <button class="refresh-btn" onclick="showUserList()">Refresh</button>
        </h3>
      </div>
      <div style="margin-bottom:12px;">
        <input type="text" id="playerSearch" placeholder="Search by privyId, username, or real name..." 
          style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--fg);font-family:inherit;font-size:14px;box-sizing:border-box;"
          value="${searchTerm.replace(/"/g, '&quot;')}"
          oninput="handlePlayerSearch(this.value)">
      </div>
      <div id="playerResultsContainer">
        ${buildPlayerCards(players, searchTerm)}
      </div>
    </div>
  `;

  show(html);
}

function buildPlayerCards(players, searchTerm) {
  if (Object.keys(players).length === 0) {
    return `<div class="keycard"><i>${searchTerm ? "No players match your search." : "No players found."}</i></div>`;
  }

  let html = "";
  for (const [id, p] of Object.entries(players)) {
    const top = Array.isArray(p.topUsernames) && p.topUsernames.length
      ? p.topUsernames
      : Object.entries(p.usernames || {})
          .sort((a,b)=>b[1]-a[1])
          .slice(0,3)
          .map(([name,count])=>({ name, count }));

    const rc = (p.regionCounts && typeof p.regionCounts === 'object') ? p.regionCounts : {};
    let tr = p.topRegion;
    if (!tr) {
      const best = Object.entries(rc).sort((a,b)=> (b[1]||0) - (a[1]||0))[0];
      tr = best ? best[0] : null;
    }
    const trCount = tr && typeof rc[tr] === 'number' ? rc[tr] : (tr ? 0 : null);

    html += `
      <div class="keycard">
        <b>${p.realName || "(unverified)"} ‚Äî ${id}</b><br>
        Top 3: ${top.length ? top.map(t => `${t.name} (${t.count})`).join(", ") : "‚Äî"}<br>
        Top Region: ${tr ? `${tr} (${trCount})` : "‚Äî"}
      </div>
    `;
  }
  return html;
}

function handlePlayerSearch(term) {
  const allPlayers = window.__ALL_PLAYERS__ || {};
  const total = window.__PLAYERS_TOTAL__;
  
  if (!term || !term.trim()) {
    renderPlayerList(allPlayers, total, "", false);
    return;
  }

  const search = term.toLowerCase().trim();
  const filtered = {};

  for (const [id, p] of Object.entries(allPlayers)) {
    // Match privyId
    if (id.toLowerCase().includes(search)) {
      filtered[id] = p;
      continue;
    }
    
    // Match realName
    if (p.realName && p.realName.toLowerCase().includes(search)) {
      filtered[id] = p;
      continue;
    }
    
    // Match any username (current or historical)
    const usernames = Object.keys(p.usernames || {});
    if (usernames.some(u => u.toLowerCase().includes(search))) {
      filtered[id] = p;
      continue;
    }
    
    // Match topUsernames
    const topNames = (p.topUsernames || []).map(t => t.name || "");
    if (topNames.some(n => n.toLowerCase().includes(search))) {
      filtered[id] = p;
      continue;
    }
  }

  renderPlayerList(filtered, total, term, false);
}

/* ---------- NEW: XP Headers Page ---------- */
async function showXpHeaders() {
  const data = await fetchJSON(`${API}/api/user/admin/client-xp`);
  const entries = data || {};

  let html = `
    <div class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <h3 style="margin:0;display:flex;align-items:center;gap:10px;">
          XP / Bearer Headers
          <button class="refresh-btn" onclick="showXpHeaders()">Refresh</button>
        </h3>
      </div>
  `;

  const cards = [];

  for (const [key, entry] of Object.entries(entries)) {
    const headers = entry.headers || {};
    const authRaw = headers.authorization || headers.Authorization || "";
    if (typeof authRaw !== "string") continue;
    const lower = authRaw.toLowerCase();
    if (!lower.startsWith("bearer ")) continue;

    const bearer = authRaw.split(" ")[1] || "";
    const ageStr = entry.lastused ? timeAgo(entry.lastused) : "unknown age";

    cards.push(`
      <div class="keycard">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
          <div>
            <b>${key}</b><br>
            <span style="font-size:12px;opacity:0.85;">Bearer:</span>
            <span style="font-size:12px;opacity:0.85;word-break:break-all;"> ${bearer}</span><br>
            <span style="font-size:12px;opacity:0.75;">Last used: ${ageStr}</span>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <button class="refresh-btn" style="padding:3px 8px;font-size:12px;"
              onclick="copyXpHeaders('${key}')">
              Copy headers
            </button>
            <button style="background:var(--red);color:#fff;border:none;padding:3px 8px;border-radius:6px;cursor:pointer;font-size:12px;"
              onclick="deleteXpHeaders('${key}')">
              Delete saved headers
            </button>
          </div>
        </div>
      </div>
    `);
  }

  if (!cards.length) {
    html += `<div class="keycard"><i>No keys with bearer headers found.</i></div>`;
  } else {
    html += cards.join("");
  }

  html += `</div>`;
  show(html);
}

/* ---------- XP Headers actions ---------- */
async function copyXpHeaders(key) {
  try {
    const data = await fetchJSON(`${API}/api/user/admin/client-xp`);
    const entry = data && data[key];
    if (!entry || !entry.headers) {
      notify(`No headers saved for ${key}`, false);
      return;
    }
    await navigator.clipboard.writeText(JSON.stringify(entry.headers, null, 2));
    notify(`Copied headers for ${key}`, true);
  } catch (e) {
    console.error(e);
    notify(`Failed to copy headers for ${key}`, false);
  }
}

async function deleteXpHeaders(key) {
  try {
    const res = await fetch(`${API}/api/user/admin/client-xp/delete`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "admin-token": ADMIN_TOKEN
      },
      body: JSON.stringify({ key })
    });
    const data = await res.json();
    if (data.ok) {
      notify(`Deleted headers for ${key}`, true);
      showXpHeaders();
    } else {
      notify(`Failed to delete headers for ${key}`, false);
    }
  } catch (e) {
    console.error(e);
    notify(`Failed to delete headers for ${key}`, false);
  }
}

/* ---------- Command pages ---------- */
function showSizeCmds(){
  show(cmdsBlock("Size Commands",[
    "list-size-keys",
    "add-size-keys 5",
    "revoke-size-key KEY-XXXX"
  ]));
}
function showUserCmds(){
  show(cmdsBlock("Username Commands",[
    "list-user-keys",
    "add-user-keys 5",
    "revoke-user-key KEY-XXXX"
  ]));
}


/* ---------- Router ---------- */
document.querySelectorAll(".dropdown a").forEach(a=>{
  a.onclick=()=>{
    const id=a.dataset.page;
    if(id==="size-keys")showSizeKeys();
    if(id==="size-cmds")showSizeCmds();
    if(id==="user-keys")showUserKeys();
    if(id==="user-cmds")showUserCmds();
    if(id==="user-list")showUserList();
    if(id==="logger")showLogger();
  };
});

/* ---------- Console Toggle ---------- */
const btn=document.getElementById("consoleBtn");
const box=document.getElementById("consoleBox");
const closeBtn=document.getElementById("closeConsole");
btn.onclick=()=>{
  const open=box.style.display==="flex";
  box.style.display=open?"none":"flex";
  btn.classList.toggle("open",!open);
};
closeBtn.onclick=()=>{
  box.style.display="none";
  btn.classList.remove("open");
};

/* ---------- Command Runner ---------- */
const input=document.getElementById("consoleInput");
input.addEventListener("keydown",async e=>{
  if(e.key!=="Enter")return;
  const cmd=e.target.value.trim();
  if(!cmd)return;
  log("> "+cmd);

  const parts=cmd.split(" ");
  const base=parts[0];
  const arg=parts[1];

  try{
    let r;
    if(base==="list-size-keys")
      r=await fetchJSON(`${API}/api/admin/list-keys`);
    else if(base==="list-user-keys")
      r=await fetchJSON(`${API}/api/user/admin/list-keys`);
    else if(base==="add-size-keys")
      r=await fetch(`${API}/api/admin/add-keys`,{method:"POST",headers:{"admin-token":ADMIN_TOKEN,"Content-Type":"application/json"},body:JSON.stringify({count:parseInt(arg||1)})}).then(r=>r.json());
    else if(base==="add-user-keys")
      r=await fetch(`${API}/api/user/admin/add-keys`,{method:"POST",headers:{"admin-token":ADMIN_TOKEN,"Content-Type":"application/json"},body:JSON.stringify({count:parseInt(arg||1)})}).then(r=>r.json());
    else if(base==="revoke-size-key")
      r=await fetch(`${API}/api/admin/revoke`,{method:"POST",headers:{"admin-token":ADMIN_TOKEN,"Content-Type":"application/json"},body:JSON.stringify({key:arg})}).then(r=>r.json());
    else if(base==="revoke-user-key")
      r=await fetch(`${API}/api/user/admin/revoke`,{method:"POST",headers:{"admin-token":ADMIN_TOKEN,"Content-Type":"application/json"},body:JSON.stringify({key:arg})}).then(r=>r.json());
    else if (base === "set-name") {
      const did = parts[1];
      const newName = parts.slice(2).join(" ");
      if (!did || !newName) {
        log("Usage: set-name did:privy:xxxx NewName");
      } else {
        const res = await fetch(`${API}/api/user/admin/set-name`, {
          method: "POST",
          headers: {
            "admin-token": ADMIN_TOKEN,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ did, name: newName })
        });
        const text = await res.text();
        try {
          r = JSON.parse(text);
        } catch {
          log(`Error: Server returned non-JSON (status ${res.status}): ${text.slice(0, 100)}`);
        }
      }
    }
    else if (base === "set-size-note") {
      const key = parts[1];
      const note = parts.slice(2).join(" ");
      if (!key || !note) {
        log("Usage: set-size-note KEY-XXXX Your note text");
      } else {
        const r2 = await fetch(`${API}/api/admin/add-note`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "admin-token": ADMIN_TOKEN
          },
          body: JSON.stringify({ key, note })
        }).then(r => r.json());
        log(JSON.stringify(r2, null, 2));
      }
    }
    else if (base === "set-user-note") {
      const key = parts[1];
      const note = parts.slice(2).join(" ");
      if (!key || !note) {
        log("Usage: set-user-note KEY-XXXX Your note text");
      } else {
        const r2 = await fetch(`${API}/api/user/admin/add-note`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "admin-token": ADMIN_TOKEN
          },
          body: JSON.stringify({ key, note })
        }).then(r => r.json());
        log(JSON.stringify(r2, null, 2));
      }
    }
    else if (base === "alert") {
      const target = parts[1];
      const message = parts.slice(2).join(" ");

      if (!target || !message) {
        log("Usage: alert (all|KEY-XXXX) message");
      } else {
        const body = {
          target: target === "all" ? "all" : "key",
          key: target === "all" ? null : target,
          message
        };

        const r2 = await fetch(`${API}/api/admin/alert`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "admin-token": ADMIN_TOKEN
          },
          body: JSON.stringify(body)
        }).then(r => r.json());

        log(JSON.stringify(r2, null, 2));
      }
    }
    else if (base === "update-core") {
      const version = parts[1];
      if (!version || !/^\d+\.\d+\.\d+$/.test(version)) {
        log("Usage: update-core (x.y.z)");
      } else {
        const res = await fetch(`${API}/api/core/bump`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-admin-token": ADMIN_TOKEN
          },
          body: JSON.stringify({ version })
        }).then(r => r.json());

        if (res.ok) log(`‚úÖ Core updated to ${res.activeVersion}`);
        else log(`‚ùå Failed: ${res.error || "unknown error"}`);
      }
    }
    else {
      log("Unknown command.");
      e.target.value="";
      return;
    }
    if (r) log(JSON.stringify(r,null,2));
  }catch(err){
    log("Error: "+err);
  }
  e.target.value="";
});

async function deleteKey(type, key) {
  const base = type === 'user' ? '/api/user/admin' : '/api/admin';
  const res = await fetch(`${base}/delete-key`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({ key })
  });
  const data = await res.json();
  alert(`Delete ${key}: ${data.ok ? '‚úÖ Success' : '‚ùå Failed'}`);
}

async function unuseKey(type, key) {
  const base = type === 'user' ? '/api/user/admin' : '/api/admin';
  const res = await fetch(`${base}/unuse-key`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({ key })
  });
  const data = await res.json();
  alert(`Unuse ${key}: ${data.ok ? '‚úÖ Success' : '‚ùå Failed'}`);
}

async function addNote(type, key, note) {
  const base = type === 'user' ? '/api/user/admin' : '/api/admin';
  const res = await fetch(`${base}/add-note`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({ key, note })
  });
  const data = await res.json();
  alert(`Note saved: ${data.ok ? '‚úÖ Success' : '‚ùå Failed'}`);
}



async function adminAction(type, action, key) {
  const base = type === 'user' ? '/api/user/admin' : '/api/admin';
  const res = await fetch(`${base}/${action}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({ key })
  });
  const data = await res.json();
  if (data.ok) {
    notify(`‚úÖ ${action.replace('-', ' ')} success for ${key}`, true);
    if (typeof refreshKeys === "function") refreshKeys(type);
  } else {
    notify(`‚ùå ${action.replace('-', ' ')} failed`, false);
  }
}

// optional ‚Äî for deleting player rows (usernames.json)
async function deletePlayer(privyId) {
  const res = await fetch(`/api/user/admin/delete-player`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({ privyId })
  });
  const data = await res.json();
  notify(data.ok ? `‚úÖ Deleted ${privyId}` : `‚ùå Failed to delete`, data.ok);

  if (typeof refreshPlayers === "function") refreshPlayers();
}

function timeAgo(isoDate) {
  const diff = Date.now() - new Date(isoDate).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return "just now";
  if (mins < 60) return `${mins} min${mins !== 1 ? "s" : ""} ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs} hour${hrs !== 1 ? "s" : ""} ago`;
  const days = Math.floor(hrs / 24);
  return `${days} day${days !== 1 ? "s" : ""} ago`;
}  

document.getElementById("popConsoleBtn").addEventListener("click", () => {
  const consoleBox = document.getElementById("consoleBox");
  if (!consoleBox) return alert("Console not found");

  const content = consoleBox.outerHTML;

  const popup = window.open("", "dbConsolePopup", "width=800,height=600,resizable=yes,scrollbars=yes");
  popup.document.write(`
    <html>
      <head>
        <title>DamnBruh Console</title>
        <style>
          body {
            margin: 0;
            background: #0f0f0f;
            color: #00ff88;
            font-family: monospace;
          }
          #consoleBox {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            padding: 12px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
          }
        </style>
      </head>
      <body>${content}</body>
    </html>
  `);
  popup.document.close();
});
</script>

<!-- ‚úÖ Step 1: Notification box -->
<div id="notifyBox"></div>
<style>
#notifyBox {
  position: fixed;
  bottom: 30px;
  left: 30px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  font-family: ui-monospace, monospace;
}
.notify {
  min-width: 220px;
  padding: 10px 14px;
  border-radius: 8px;
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(0,0,0,.4);
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInOut 3s ease forwards;
}
.notify.ok { background: rgba(34,197,94,.9); }
.notify.err { background: rgba(239,68,68,.9); }

@keyframes fadeInOut {
  0% { opacity:0; transform:translateY(20px); }
  10% { opacity:1; transform:translateY(0); }
  80% { opacity:1; }
  100% { opacity:0; transform:translateY(20px); }
}
</style>

</body>
</html>
