<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DamnBruh Admin Panel</title>
<style>
:root {
  --bg:#0d0d0d;
  --fg:#eaeaea;
  --accent:#4ade80;
  --panel:#1a1a1a;
  --border:#333;
  --hover:#222;
  --red:#ef4444;
  --green:#22c55e;
}
body {
  margin:0;
  font-family:ui-monospace,monospace;
  background:var(--bg);
  color:var(--fg);
}

/* ===== HEADER ===== */
header {
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px 16px;
  background:#111;
  border-bottom:1px solid var(--border);
  position:sticky;
  top:0;
  z-index:10;
}

h2 {
  position:absolute;
  right:20px;
  top:50%;
  transform:translateY(-50%);
  color:var(--accent);
  font-weight:700;
  margin:0;
  font-size:20px;
}

nav {
  display:flex;
  gap:60px;
  align-items:center;
  justify-content:center;
  position:relative;
}

nav .menu {
  position:relative;
  cursor:pointer;
  text-align:center;
  padding:8px 14px;
  font-size:16px;
  user-select:none;
}

.dropdown {
  opacity:0;
  visibility:hidden;
  position:absolute;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  top:38px;
  left:50%;
  transform:translateX(-50%);
  min-width:200px;
  box-shadow:0 4px 20px rgba(0,0,0,.6);
  transition:opacity .3s ease, visibility .3s ease;
}

.menu:hover .dropdown {
  opacity:1;
  visibility:visible;
}

.dropdown a {
  display:block;
  padding:12px 14px;
  color:var(--fg);
  text-decoration:none;
  text-align:center;
  font-size:15px;
}
.dropdown a:hover { background:var(--hover); }

/* ===== CONSOLE BUTTON ===== */
#consoleBtn {
  position:absolute;
  left:16px;
  display:flex;
  align-items:center;
  gap:6px;
  background:var(--red);
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  transition:background .25s ease;
}
#consoleBtn.open { background:var(--green); }

/* ===== MAIN CONTENT ===== */
main {
  padding:20px;
  max-width:900px;
  margin:auto;
}
.panel {
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  padding:16px;
  margin-bottom:20px;
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}
.keycard {
  background:#121212;
  border:1px solid var(--border);
  border-radius:6px;
  padding:10px;
  margin:6px 0;
}
.keycard.used { border-left:4px solid orange; }
.keycard.revoked { border-left:4px solid crimson; }
.copybtn {
  float:right;
  background:var(--accent);
  color:#000;
  border:none;
  padding:2px 6px;
  border-radius:4px;
  cursor:pointer;
}

/* ===== CONSOLE ===== */
#consoleBox {
  position:fixed;
  bottom:20px;
  right:20px;
  width:500px;
  height:700px;
  max-height:1000px;
  display:none;
  flex-direction:column;
  background:#000;
  border:1px solid var(--border);
  border-radius:8px;
  box-shadow:0 0 20px rgba(0,0,0,.6);
  overflow:hidden;
  z-index:100;
}
#consoleHeader {
  background:#111;
  color:var(--accent);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 10px;
  border-bottom:1px solid var(--border);
}
#consoleHistory {
  flex:1;
  overflow-y:auto;
  padding:8px;
  font-size:14px;
  max-height:530px;
}
#consoleInput {
  border:none;
  border-top:1px solid var(--border);
  background:#000;
  color:var(--fg);
  padding:8px;
  font-family:inherit;
  outline:none;
}
#infoTip {
  display:none;
  position:absolute;
  background:#111;
  color:var(--fg);
  font-size:13px;
  border:1px solid var(--border);
  border-radius:6px;
  padding:8px;
  top:-140%;
  right:0;
  width:260px;
  z-index:101;
}
.info:hover #infoTip { display:block; }
</style>
</head>
<body>

<header>
  <button id="consoleBtn">
    üíª <span>Console</span>
  </button>
  <h2>DamnBruh Admin</h2>
  <nav>
    <div class="menu">Size
      <div class="dropdown">
        <a data-page="size-keys">All Keys</a>
        <a data-page="size-cmds">Commands</a>
      </div>
    </div>

    <div class="menu">Usernames
      <div class="dropdown">
        <a data-page="user-keys">All Keys</a>
        <a data-page="user-list">All Saved Usernames</a>
        <a data-page="user-cmds">Commands</a>
      </div>
    </div>
  </nav>
</header>

<main id="content">
  <div class="panel" style="text-align:center;"><h1>Welcome</h1></div>
</main>

<!-- Console -->
<div id="consoleBox">
  <div id="consoleHeader">
    <span>üíª Command Console</span>
    <div style="display:flex;gap:8px;align-items:center;position:relative;">
      <div class="info" style="position:relative;cursor:pointer;">‚ÑπÔ∏è
        <div id="infoTip">
          <b>Common Commands:</b><br>
          list-size-keys<br>
          list-user-keys<br>
          add-size-keys 5<br>
          add-user-keys 5<br>
          revoke-size-key KEY-XXXX<br>
          revoke-user-key KEY-XXXX
        </div>
      </div>
      <span id="closeConsole" style="cursor:pointer;">‚ùå</span>
    </div>
  </div>
  <div id="consoleHistory"></div>
  <input id="consoleInput" placeholder="Enter command...">
</div>

<script>
const API = "https://dbserver-8bhx.onrender.com";
const ADMIN_TOKEN = "vibran2566";

/* ---------- Helpers ---------- */
async function fetchJSON(url) {
  const r = await fetch(url, { headers: { "admin-token": ADMIN_TOKEN } });
  return r.json();
}
function show(html){ document.getElementById("content").innerHTML = html; }
function log(msg){
  const div=document.createElement("div");
  div.textContent=msg;
  document.getElementById("consoleHistory").appendChild(div);
  div.scrollIntoView({behavior:"smooth"});
}

/* ‚úÖ Step 2 ‚Äî Notification Helper */
function notify(msg, ok=true) {
  const box = document.getElementById("notifyBox");
  const n = document.createElement("div");
  n.className = `notify ${ok ? "ok" : "err"}`;
  n.textContent = msg;
  box.appendChild(n);
  setTimeout(() => n.remove(), 3200);
}

/* ---------- UI Builders ---------- */
function keyCard(k, type="size"){
  const cls = k.revoked ? "revoked" : k.used ? "used" : "";
  return `
  <div class="keycard ${cls}">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <b>${k.key}</b>
      <div style="display:flex;gap:8px;">
        <button title="Delete" onclick="adminAction('${type}','delete-key','${k.key}')">üóëÔ∏è</button>
        <button title="Unuse" onclick="adminAction('${type}','unuse-key','${k.key}')">üîÅ</button>
        <button title="Revoke" onclick="adminAction('${type}','revoke','${k.key}')">‚ùå</button>
      </div>
    </div>
    Used: ${k.used} | Revoked: ${k.revoked}<br>
    Created: ${new Date(k.createdAt).toLocaleString()}<br>
    ${k.usedAt ? `Used: ${new Date(k.usedAt).toLocaleString()}` : ""}
    ${k.note ? `<br><i>Note:</i> ${k.note}` : ""}
  </div>`;
}


function cmdsBlock(title, lines){
  return `<div class="panel"><h3>${title}</h3>${
    lines.map(c=>`<div><code>${c}</code>
    <button class="copybtn" onclick="navigator.clipboard.writeText('${c}')">Copy</button></div>`).join("")
  }</div>`;
}

/* ---------- Pages ---------- */
async function showSizeKeys(){
  const d = await fetchJSON(`${API}/api/admin/list-keys`);
  show(`
    <div class="panel">
      <h3>Size Keys</h3>
      ${d.keys.map(k => keyCard(k, "size")).join("")}
    </div>
  `);
}
async function showUserKeys(){
  const d = await fetchJSON(`${API}/api/user/admin/list-keys`);
  show(`
    <div class="panel">
      <h3>Username Keys</h3>
      ${d.keys.map(k => keyCard(k, "user")).join("")}
    </div>
  `);
}
async function showUserList(){
  const d=await fetchJSON(`${API}/api/user/mapping`);
  let html=`<div class="panel"><h3>Saved Usernames</h3>`;
  for(const [id,p] of Object.entries(d.players||{})){
    html+=`<div class="keycard">
      <b>${p.realName||"(unverified)"} ‚Äî ${id}</b><br>
      <i>Top 3:</i> ${p.topUsernames.map(t=>`${t.name} (${t.count})`).join(", ")}
    </div>`;
  }
  html+=`</div>`;
  show(html);
}
function showSizeCmds(){
  show(cmdsBlock("Size Commands",[
    "list-size-keys",
    "add-size-keys 5",
    "revoke-size-key KEY-XXXX"
  ]));
}
function showUserCmds(){
  show(cmdsBlock("Username Commands",[
    "list-user-keys",
    "add-user-keys 5",
    "revoke-user-key KEY-XXXX"
  ]));
}


/* ---------- Router ---------- */
document.querySelectorAll(".dropdown a").forEach(a=>{
  a.onclick=()=>{
    const id=a.dataset.page;
    if(id==="size-keys")showSizeKeys();
    if(id==="size-cmds")showSizeCmds();
    if(id==="user-keys")showUserKeys();
    if(id==="user-cmds")showUserCmds();
    if(id==="user-list")showUserList();
  };
});

/* ---------- Console Toggle ---------- */
const btn=document.getElementById("consoleBtn");
const box=document.getElementById("consoleBox");
const closeBtn=document.getElementById("closeConsole");
btn.onclick=()=>{
  const open=box.style.display==="flex";
  box.style.display=open?"none":"flex";
  btn.classList.toggle("open",!open);
};
closeBtn.onclick=()=>{
  box.style.display="none";
  btn.classList.remove("open");
};

/* ---------- Command Runner ---------- */
const input=document.getElementById("consoleInput");
input.addEventListener("keydown",async e=>{
  if(e.key!=="Enter")return;
  const cmd=e.target.value.trim();
  if(!cmd)return;
  log("> "+cmd);

  const parts=cmd.split(" ");
  const base=parts[0];
  const arg=parts[1];

  try{
    let r;
    if(base==="list-size-keys")
      r=await fetchJSON(`${API}/api/admin/list-keys`);
    else if(base==="list-user-keys")
      r=await fetchJSON(`${API}/api/user/admin/list-keys`);
    else if(base==="add-size-keys")
      r=await fetch(`${API}/api/admin/add-keys`,{method:"POST",headers:{"admin-token":ADMIN_TOKEN,"Content-Type":"application/json"},body:JSON.stringify({count:parseInt(arg||1)})}).then(r=>r.json());
    else if(base==="add-user-keys")
      r=await fetch(`${API}/api/user/admin/add-keys`,{method:"POST",headers:{"admin-token":ADMIN_TOKEN,"Content-Type":"application/json"},body:JSON.stringify({count:parseInt(arg||1)})}).then(r=>r.json());
    else if(base==="revoke-size-key")
      r=await fetch(`${API}/api/admin/revoke`,{method:"POST",headers:{"admin-token":ADMIN_TOKEN,"Content-Type":"application/json"},body:JSON.stringify({key:arg})}).then(r=>r.json());
    else if(base==="revoke-user-key")
      r=await fetch(`${API}/api/user/admin/revoke`,{method:"POST",headers:{"admin-token":ADMIN_TOKEN,"Content-Type":"application/json"},body:JSON.stringify({key:arg})}).then(r=>r.json());
    else if (base === "set-name") {
  const did = parts[1];
  const newName = parts.slice(2).join(" ");
  if (!did || !newName) {
    log("Usage: set-name did:privy:xxxx NewName");
  } else {
    r = await fetch(`${API}/api/user/admin/set-name`, {
      method: "POST",
      headers: {
        "admin-token": ADMIN_TOKEN,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ did, name: newName })
    }).then(r => r.json());
  }
}

    else {
      log("Unknown command.");
      e.target.value="";
      return;
    }
    log(JSON.stringify(r,null,2));
  }catch(err){
    log("Error: "+err);
  }
  e.target.value="";
});

async function deleteKey(type, key) {
  const base = type === 'user' ? '/api/user/admin' : '/api/admin';
  const res = await fetch(`${base}/delete-key`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({ key })
  });
  const data = await res.json();
  alert(`Delete ${key}: ${data.ok ? '‚úÖ Success' : '‚ùå Failed'}`);
}

async function unuseKey(type, key) {
  const base = type === 'user' ? '/api/user/admin' : '/api/admin';
  const res = await fetch(`${base}/unuse-key`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({ key })
  });
  const data = await res.json();
  alert(`Unuse ${key}: ${data.ok ? '‚úÖ Success' : '‚ùå Failed'}`);
}

async function addNote(type, key, note) {
  const base = type === 'user' ? '/api/user/admin' : '/api/admin';
  const res = await fetch(`${base}/add-note`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({ key, note })
  });
  const data = await res.json();
  alert(`Note saved: ${data.ok ? '‚úÖ Success' : '‚ùå Failed'}`);
}



async function adminAction(type, action, key) {
  const base = type === 'user' ? '/api/user/admin' : '/api/admin';
  const res = await fetch(`${base}/${action}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({ key })
  });
  const data = await res.json();
  if (data.ok) {
  notify(`‚úÖ ${action.replace('-', ' ')} success for ${key}`, true);
  refreshKeys && refreshKeys(type);
} else {
  notify(`‚ùå ${action.replace('-', ' ')} failed`, false);
}

}

// optional ‚Äî for deleting player rows (usernames.json)
async function deletePlayer(privyId) {
  const res = await fetch(`/api/user/admin/delete-player`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "admin-token": ADMIN_TOKEN
    },
    body: JSON.stringify({ privyId })
  });
  const data = await res.json();
  notify(data.ok ? `‚úÖ Deleted ${privyId}` : `‚ùå Failed to delete`, data.ok);

  refreshPlayers && refreshPlayers();
}
</script>


<!-- ‚úÖ Step 1: Notification box -->
<div id="notifyBox"></div>
<style>
#notifyBox {
  position: fixed;
  bottom: 30px;
  left: 30px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  font-family: ui-monospace, monospace;
}
.notify {
  min-width: 220px;
  padding: 10px 14px;
  border-radius: 8px;
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(0,0,0,.4);
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInOut 3s ease forwards;
}
.notify.ok { background: rgba(34,197,94,.9); }
.notify.err { background: rgba(239,68,68,.9); }

@keyframes fadeInOut {
  0% { opacity:0; transform:translateY(20px); }
  10% { opacity:1; transform:translateY(0); }
  80% { opacity:1; }
  100% { opacity:0; transform:translateY(20px); }
}
</style>


</body>
</html>
